<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè®¾ç½®è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            margin: 5px;
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        textarea {
            width: 100%;
            height: 200px;
            margin: 10px 0;
        }

        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <h1>AIè®¾ç½®è°ƒè¯•å·¥å…·</h1>

    <div class="section">
        <h3>IndexedDB çŠ¶æ€æ£€æŸ¥</h3>
        <button onclick="checkIndexedDB()">æ£€æŸ¥IndexedDBæ”¯æŒ</button>
        <button onclick="listDatabases()">åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“</button>
        <button onclick="checkAISettingsTable()">æ£€æŸ¥AIè®¾ç½®è¡¨</button>
        <div id="dbStatus" class="log"></div>
    </div>

    <div class="section">
        <h3>AIé…ç½®æµ‹è¯•</h3>
        <button onclick="saveTestConfig()">ä¿å­˜æµ‹è¯•é…ç½®</button>
        <button onclick="loadConfig()">åŠ è½½é…ç½®</button>
        <button onclick="clearConfig()">æ¸…é™¤é…ç½®</button>
        <textarea id="configOutput" placeholder="é…ç½®ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
    </div>

    <div class="section">
        <h3>æ“ä½œæ—¥å¿—</h3>
        <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function checkIndexedDB() {
            log('æ£€æŸ¥IndexedDBæ”¯æŒ...');

            if (!window.indexedDB) {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒIndexedDB');
                return;
            }

            log('âœ… æµè§ˆå™¨æ”¯æŒIndexedDB');

            try {
                // å°è¯•æ‰“å¼€æ•°æ®åº“
                const request = indexedDB.open('StickyNotesDB', 2);

                request.onerror = () => {
                    log('âŒ æ— æ³•æ‰“å¼€æ•°æ®åº“: ' + request.error);
                };

                request.onsuccess = (event) => {
                    const db = event.target.result;
                    log('âœ… æˆåŠŸæ‰“å¼€æ•°æ®åº“: ' + db.name + ' (ç‰ˆæœ¬: ' + db.version + ')');

                    const storeNames = Array.from(db.objectStoreNames);
                    log('ğŸ“‹ å¯¹è±¡å­˜å‚¨åˆ—è¡¨: ' + storeNames.join(', '));

                    if (storeNames.includes('ai_settings')) {
                        log('âœ… ai_settings è¡¨å­˜åœ¨');
                    } else {
                        log('âŒ ai_settings è¡¨ä¸å­˜åœ¨');
                    }

                    db.close();
                };

                request.onupgradeneeded = (event) => {
                    log('ğŸ”„ æ•°æ®åº“éœ€è¦å‡çº§...');
                    const db = event.target.result;

                    // åˆ›å»ºAIè®¾ç½®è¡¨
                    if (!db.objectStoreNames.contains('ai_settings')) {
                        const aiSettingsStore = db.createObjectStore('ai_settings', {
                            keyPath: 'id',
                        });
                        aiSettingsStore.createIndex('user_id', 'user_id', { unique: false });
                        aiSettingsStore.createIndex('updated_at', 'updated_at', { unique: false });
                        log('âœ… åˆ›å»ºäº† ai_settings è¡¨');
                    }
                };
            } catch (error) {
                log('âŒ IndexedDBæ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        async function listDatabases() {
            log('åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“...');

            if (navigator.storage && navigator.storage.estimate) {
                try {
                    const estimate = await navigator.storage.estimate();
                    log(`ğŸ“Š å­˜å‚¨ä½¿ç”¨æƒ…å†µ: ${Math.round(estimate.usage / 1024)} KB / ${Math.round(estimate.quota / 1024 / 1024)} MB`);
                } catch (error) {
                    log('âŒ æ— æ³•è·å–å­˜å‚¨ä¿¡æ¯: ' + error.message);
                }
            }
        }

        async function checkAISettingsTable() {
            log('æ£€æŸ¥AIè®¾ç½®è¡¨å†…å®¹...');

            try {
                const request = indexedDB.open('StickyNotesDB', 2);

                request.onsuccess = (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('ai_settings')) {
                        log('âŒ ai_settings è¡¨ä¸å­˜åœ¨');
                        db.close();
                        return;
                    }

                    const transaction = db.transaction(['ai_settings'], 'readonly');
                    const store = transaction.objectStore('ai_settings');
                    const getAllRequest = store.getAll();

                    getAllRequest.onsuccess = () => {
                        const results = getAllRequest.result;
                        log(`ğŸ“‹ ai_settings è¡¨ä¸­æœ‰ ${results.length} æ¡è®°å½•`);

                        results.forEach((item, index) => {
                            log(`è®°å½• ${index + 1}: ID=${item.id}, user_id=${item.user_id}, enableAI=${item.enableAI}`);
                        });

                        if (results.length === 0) {
                            log('ğŸ’¡ è¡¨ä¸ºç©ºï¼Œè¿™å¯èƒ½æ˜¯æ•°æ®ä¿å­˜å¤±è´¥çš„åŸå› ');
                        }
                    };

                    getAllRequest.onerror = () => {
                        log('âŒ è¯»å–ai_settingsè¡¨å¤±è´¥: ' + getAllRequest.error);
                    };

                    transaction.oncomplete = () => {
                        db.close();
                    };
                };

                request.onerror = () => {
                    log('âŒ æ— æ³•æ‰“å¼€æ•°æ®åº“: ' + request.error);
                };
            } catch (error) {
                log('âŒ æ£€æŸ¥è¡¨å¤±è´¥: ' + error.message);
            }
        }

        async function saveTestConfig() {
            log('ä¿å­˜æµ‹è¯•AIé…ç½®...');

            const testConfig = {
                id: 'ai-settings',
                user_id: 'default',
                enableAI: true,
                aiModel: 'deepseek-chat',
                apiKey: 'test-api-key-12345',
                apiUrl: 'https://api.deepseek.com/v1',
                temperature: 0.7,
                maxTokens: 1000,
                updated_at: new Date().toISOString()
            };

            try {
                const request = indexedDB.open('StickyNotesDB', 2);

                request.onsuccess = (event) => {
                    const db = event.target.result;

                    const transaction = db.transaction(['ai_settings'], 'readwrite');
                    const store = transaction.objectStore('ai_settings');
                    const putRequest = store.put(testConfig);

                    putRequest.onsuccess = () => {
                        log('âœ… æµ‹è¯•é…ç½®ä¿å­˜æˆåŠŸ');
                        db.close();
                    };

                    putRequest.onerror = () => {
                        log('âŒ ä¿å­˜å¤±è´¥: ' + putRequest.error);
                        db.close();
                    };
                };

                request.onerror = () => {
                    log('âŒ æ— æ³•æ‰“å¼€æ•°æ®åº“: ' + request.error);
                };
            } catch (error) {
                log('âŒ ä¿å­˜æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        async function loadConfig() {
            log('åŠ è½½AIé…ç½®...');

            try {
                const request = indexedDB.open('StickyNotesDB', 2);

                request.onsuccess = (event) => {
                    const db = event.target.result;

                    const transaction = db.transaction(['ai_settings'], 'readonly');
                    const store = transaction.objectStore('ai_settings');
                    const getRequest = store.get('ai-settings');

                    getRequest.onsuccess = () => {
                        const result = getRequest.result;

                        if (result) {
                            log('âœ… é…ç½®åŠ è½½æˆåŠŸ');
                            document.getElementById('configOutput').value = JSON.stringify(result, null, 2);
                        } else {
                            log('âš ï¸ æ²¡æœ‰æ‰¾åˆ°é…ç½®æ•°æ®');
                            document.getElementById('configOutput').value = 'æ²¡æœ‰æ‰¾åˆ°é…ç½®æ•°æ®';
                        }

                        db.close();
                    };

                    getRequest.onerror = () => {
                        log('âŒ åŠ è½½å¤±è´¥: ' + getRequest.error);
                        db.close();
                    };
                };

                request.onerror = () => {
                    log('âŒ æ— æ³•æ‰“å¼€æ•°æ®åº“: ' + request.error);
                };
            } catch (error) {
                log('âŒ åŠ è½½æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        async function clearConfig() {
            log('æ¸…é™¤AIé…ç½®...');

            try {
                const request = indexedDB.open('StickyNotesDB', 2);

                request.onsuccess = (event) => {
                    const db = event.target.result;

                    const transaction = db.transaction(['ai_settings'], 'readwrite');
                    const store = transaction.objectStore('ai_settings');
                    const deleteRequest = store.delete('ai-settings');

                    deleteRequest.onsuccess = () => {
                        log('âœ… é…ç½®æ¸…é™¤æˆåŠŸ');
                        document.getElementById('configOutput').value = '';
                        db.close();
                    };

                    deleteRequest.onerror = () => {
                        log('âŒ æ¸…é™¤å¤±è´¥: ' + deleteRequest.error);
                        db.close();
                    };
                };

                request.onerror = () => {
                    log('âŒ æ— æ³•æ‰“å¼€æ•°æ®åº“: ' + request.error);
                };
            } catch (error) {
                log('âŒ æ¸…é™¤æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = () => {
            log('ğŸš€ AIè®¾ç½®è°ƒè¯•å·¥å…·å·²åŠ è½½');
            checkIndexedDB();
        };
    </script>
</body>

</html>