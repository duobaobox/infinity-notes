<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI设置调试工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            margin: 5px;
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        textarea {
            width: 100%;
            height: 200px;
            margin: 10px 0;
        }

        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <h1>AI设置调试工具</h1>

    <div class="section">
        <h3>IndexedDB 状态检查</h3>
        <button onclick="checkIndexedDB()">检查IndexedDB支持</button>
        <button onclick="listDatabases()">列出所有数据库</button>
        <button onclick="checkAISettingsTable()">检查AI设置表</button>
        <div id="dbStatus" class="log"></div>
    </div>

    <div class="section">
        <h3>AI配置测试</h3>
        <button onclick="saveTestConfig()">保存测试配置</button>
        <button onclick="loadConfig()">加载配置</button>
        <button onclick="clearConfig()">清除配置</button>
        <textarea id="configOutput" placeholder="配置结果将显示在这里..."></textarea>
    </div>

    <div class="section">
        <h3>操作日志</h3>
        <button onclick="clearLog()">清除日志</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function checkIndexedDB() {
            log('检查IndexedDB支持...');

            if (!window.indexedDB) {
                log('❌ 浏览器不支持IndexedDB');
                return;
            }

            log('✅ 浏览器支持IndexedDB');

            try {
                // 尝试打开数据库
                const request = indexedDB.open('StickyNotesDB', 2);

                request.onerror = () => {
                    log('❌ 无法打开数据库: ' + request.error);
                };

                request.onsuccess = (event) => {
                    const db = event.target.result;
                    log('✅ 成功打开数据库: ' + db.name + ' (版本: ' + db.version + ')');

                    const storeNames = Array.from(db.objectStoreNames);
                    log('📋 对象存储列表: ' + storeNames.join(', '));

                    if (storeNames.includes('ai_settings')) {
                        log('✅ ai_settings 表存在');
                    } else {
                        log('❌ ai_settings 表不存在');
                    }

                    db.close();
                };

                request.onupgradeneeded = (event) => {
                    log('🔄 数据库需要升级...');
                    const db = event.target.result;

                    // 创建AI设置表
                    if (!db.objectStoreNames.contains('ai_settings')) {
                        const aiSettingsStore = db.createObjectStore('ai_settings', {
                            keyPath: 'id',
                        });
                        aiSettingsStore.createIndex('user_id', 'user_id', { unique: false });
                        aiSettingsStore.createIndex('updated_at', 'updated_at', { unique: false });
                        log('✅ 创建了 ai_settings 表');
                    }
                };
            } catch (error) {
                log('❌ IndexedDB操作失败: ' + error.message);
            }
        }

        async function listDatabases() {
            log('列出所有数据库...');

            if (navigator.storage && navigator.storage.estimate) {
                try {
                    const estimate = await navigator.storage.estimate();
                    log(`📊 存储使用情况: ${Math.round(estimate.usage / 1024)} KB / ${Math.round(estimate.quota / 1024 / 1024)} MB`);
                } catch (error) {
                    log('❌ 无法获取存储信息: ' + error.message);
                }
            }
        }

        async function checkAISettingsTable() {
            log('检查AI设置表内容...');

            try {
                const request = indexedDB.open('StickyNotesDB', 2);

                request.onsuccess = (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('ai_settings')) {
                        log('❌ ai_settings 表不存在');
                        db.close();
                        return;
                    }

                    const transaction = db.transaction(['ai_settings'], 'readonly');
                    const store = transaction.objectStore('ai_settings');
                    const getAllRequest = store.getAll();

                    getAllRequest.onsuccess = () => {
                        const results = getAllRequest.result;
                        log(`📋 ai_settings 表中有 ${results.length} 条记录`);

                        results.forEach((item, index) => {
                            log(`记录 ${index + 1}: ID=${item.id}, user_id=${item.user_id}, enableAI=${item.enableAI}`);
                        });

                        if (results.length === 0) {
                            log('💡 表为空，这可能是数据保存失败的原因');
                        }
                    };

                    getAllRequest.onerror = () => {
                        log('❌ 读取ai_settings表失败: ' + getAllRequest.error);
                    };

                    transaction.oncomplete = () => {
                        db.close();
                    };
                };

                request.onerror = () => {
                    log('❌ 无法打开数据库: ' + request.error);
                };
            } catch (error) {
                log('❌ 检查表失败: ' + error.message);
            }
        }

        async function saveTestConfig() {
            log('保存测试AI配置...');

            const testConfig = {
                id: 'ai-settings',
                user_id: 'default',
                enableAI: true,
                aiModel: 'deepseek-chat',
                apiKey: 'test-api-key-12345',
                apiUrl: 'https://api.deepseek.com/v1',
                temperature: 0.7,
                maxTokens: 1000,
                updated_at: new Date().toISOString()
            };

            try {
                const request = indexedDB.open('StickyNotesDB', 2);

                request.onsuccess = (event) => {
                    const db = event.target.result;

                    const transaction = db.transaction(['ai_settings'], 'readwrite');
                    const store = transaction.objectStore('ai_settings');
                    const putRequest = store.put(testConfig);

                    putRequest.onsuccess = () => {
                        log('✅ 测试配置保存成功');
                        db.close();
                    };

                    putRequest.onerror = () => {
                        log('❌ 保存失败: ' + putRequest.error);
                        db.close();
                    };
                };

                request.onerror = () => {
                    log('❌ 无法打开数据库: ' + request.error);
                };
            } catch (error) {
                log('❌ 保存操作失败: ' + error.message);
            }
        }

        async function loadConfig() {
            log('加载AI配置...');

            try {
                const request = indexedDB.open('StickyNotesDB', 2);

                request.onsuccess = (event) => {
                    const db = event.target.result;

                    const transaction = db.transaction(['ai_settings'], 'readonly');
                    const store = transaction.objectStore('ai_settings');
                    const getRequest = store.get('ai-settings');

                    getRequest.onsuccess = () => {
                        const result = getRequest.result;

                        if (result) {
                            log('✅ 配置加载成功');
                            document.getElementById('configOutput').value = JSON.stringify(result, null, 2);
                        } else {
                            log('⚠️ 没有找到配置数据');
                            document.getElementById('configOutput').value = '没有找到配置数据';
                        }

                        db.close();
                    };

                    getRequest.onerror = () => {
                        log('❌ 加载失败: ' + getRequest.error);
                        db.close();
                    };
                };

                request.onerror = () => {
                    log('❌ 无法打开数据库: ' + request.error);
                };
            } catch (error) {
                log('❌ 加载操作失败: ' + error.message);
            }
        }

        async function clearConfig() {
            log('清除AI配置...');

            try {
                const request = indexedDB.open('StickyNotesDB', 2);

                request.onsuccess = (event) => {
                    const db = event.target.result;

                    const transaction = db.transaction(['ai_settings'], 'readwrite');
                    const store = transaction.objectStore('ai_settings');
                    const deleteRequest = store.delete('ai-settings');

                    deleteRequest.onsuccess = () => {
                        log('✅ 配置清除成功');
                        document.getElementById('configOutput').value = '';
                        db.close();
                    };

                    deleteRequest.onerror = () => {
                        log('❌ 清除失败: ' + deleteRequest.error);
                        db.close();
                    };
                };

                request.onerror = () => {
                    log('❌ 无法打开数据库: ' + request.error);
                };
            } catch (error) {
                log('❌ 清除操作失败: ' + error.message);
            }
        }

        // 页面加载时自动检查
        window.onload = () => {
            log('🚀 AI设置调试工具已加载');
            checkIndexedDB();
        };
    </script>
</body>

</html>